<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¦è¾†èŠ‚ç‚¹æ¨¡æ‹Ÿå™¨</title>
    <link rel="stylesheet" href="static/css/style.css">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #28a745;
        }
        
        .status-offline {
            background-color: #dc3545;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .data-panel {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: black;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        input[type="number"] {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .data-item {
            padding: 5px;
            margin: 2px 0;
            background: white;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— è½¦è¾†èŠ‚ç‚¹æ¨¡æ‹Ÿå™¨</h1>
            <p>ç”¨äºæµ‹è¯•å¤´ç›”èŠ‚ç‚¹ï¼ˆcommunicationæ¨¡å—ï¼‰çš„é€šä¿¡åŠŸèƒ½</p>
            <div id="connection-status">
                <span class="status-indicator status-offline"></span>
                <span>æœªè¿æ¥</span>
            </div>
        </div>

        <!-- è½¦è¾†çŠ¶æ€æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <h3>ğŸš— è½¦è¾†çŠ¶æ€æ§åˆ¶</h3>
            <div>
                <button id="toggle-vehicle-status" class="btn-primary">å¯åŠ¨</button>
                <span id="vehicle-status-text">è½¦è¾†çŠ¶æ€å‘é€: å…³é—­</span>
            </div>
            <div>
                <label>å‘é€é¢‘ç‡ (Hz): </label>
                <input type="number" id="vehicle-status-interval" value="20" min="1" max="100" step="1">
                <button id="set-interval" class="btn-warning">è®¾ç½®</button>
            </div>
        </div>

        <!-- æ•°æ®ç›‘æ§é¢æ¿ -->
        <div class="control-panel">
            <h3>ğŸ“Š æ•°æ®ç›‘æ§</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>å®æ—¶æ•°æ®</h4>
                    <div id="realtime-data" class="data-panel">
                        <div class="data-item">æš‚æ— æ•°æ®</div>
                    </div>
                </div>
                <div>
                    <h4>å¤´éƒ¨è·Ÿè¸ªæ•°æ®</h4>
                    <div id="head-tracking-data" class="data-panel">
                        <div class="data-item">æš‚æ— æ•°æ®</div>
                    </div>
                </div>
                <div>
                    <h4>è¯­éŸ³æ–‡æœ¬æ•°æ®</h4>
                    <div id="voice-text-data" class="data-panel">
                        <div class="data-item">æš‚æ— æ•°æ®</div>
                    </div>
                </div>
                <div>
                    <h4>è¯­éŸ³å‘½ä»¤æ•°æ®</h4>
                    <div id="voice-command-data" class="data-panel">
                        <div class="data-item">æš‚æ— æ•°æ®</div>
                    </div>
                </div>
                <div>
                    <h4>ç¡®è®¤åŒ…æ•°æ®</h4>
                    <div id="ack-data" class="data-panel">
                        <div class="data-item">æš‚æ— æ•°æ®</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="control-panel">
            <h3>ğŸ“ ç³»ç»Ÿæ—¥å¿—</h3>
            <div id="log-content" class="log">
                <div>ç­‰å¾…è¿æ¥...</div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectInterval = 3000;
        let vehicleStatusEnabled = false;
        let stats = {
            realtimeReceived: 0,
            headTrackingReceived: 0,
            voiceTextReceived: 0,
            voiceCommandReceived: 0,
            ackReceived: 0,
            ackSent: 0
        };
        
        function log(message, type = 'info') {
            const logContent = document.getElementById('log-content');
            if (!logContent) {
                console.log(`[${type.toUpperCase()}] ${message}`);
                return;
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const levelClass = `log-${type}`;
            entry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="${levelClass}">${message}</span>
            `;
            
            logContent.insertBefore(entry, logContent.firstChild);
            
            // ä¿æŒæœ€å¤š100æ¡æ—¥å¿—
            while (logContent.children.length > 100) {
                logContent.removeChild(logContent.lastChild);
            }
            
            // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
            console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (!statusElement) {
                log('æ‰¾ä¸åˆ°connection-statuså…ƒç´ ', 'error');
                return;
            }
            
            const indicator = statusElement.querySelector('.status-indicator');
            const text = statusElement.querySelector('span:last-child');
            
            if (!indicator || !text) {
                log('æ‰¾ä¸åˆ°çŠ¶æ€æŒ‡ç¤ºå™¨æˆ–æ–‡æœ¬å…ƒç´ ', 'error');
                return;
            }
            
            if (connected) {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'å·²è¿æ¥';
                isConnected = true;
                log('è¿æ¥çŠ¶æ€æ›´æ–°ä¸º: å·²è¿æ¥', 'info');
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'æœªè¿æ¥';
                isConnected = false;
                log('è¿æ¥çŠ¶æ€æ›´æ–°ä¸º: æœªè¿æ¥', 'warning');
            }
        }
        
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('WebSocketå·²ç»è¿æ¥', 'warning');
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            log(`å°è¯•è¿æ¥WebSocket: ${wsUrl}`, 'info');
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function(event) {
                    log('WebSocket onopenäº‹ä»¶è§¦å‘', 'info');
                    isConnected = true;
                    reconnectAttempts = 0;
                    updateConnectionStatus(true);
                    log('WebSocketè¿æ¥å·²å»ºç«‹', 'info');
                    
                    // è¯·æ±‚åˆå§‹çŠ¶æ€
                    sendMessage({
                        type: 'get_status'
                    });
                };
                
                ws.onmessage = function(event) {
                    log(`æ”¶åˆ°æ¶ˆæ¯: ${event.data}`, 'info');
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (e) {
                        log(`è§£ææ¶ˆæ¯å¤±è´¥: ${e.message}`, 'error');
                    }
                };
                
                ws.onclose = function(event) {
                    log(`WebSocketè¿æ¥å·²æ–­å¼€: ä»£ç =${event.code}, åŸå› =${event.reason}`, 'warning');
                    updateConnectionStatus(false);
                    
                    // è‡ªåŠ¨é‡è¿
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        log(`å°è¯•é‡è¿ (${reconnectAttempts}/${maxReconnectAttempts})...`, 'info');
                        setTimeout(connectWebSocket, reconnectInterval);
                    } else {
                        log('é‡è¿å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é‡è¿', 'error');
                    }
                };
                
                ws.onerror = function(error) {
                    log(`WebSocketé”™è¯¯: ${error}`, 'error');
                    console.error('WebSocketé”™è¯¯è¯¦æƒ…:', error);
                };
                
            } catch (error) {
                log(`è¿æ¥WebSocketå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function handleMessage(message) {
            switch (message.type) {
                case 'status':
                    handleStatusMessage(message.data);
                    break;
                case 'data_update':
                    handleDataUpdate(message.data_type, message.data);
                    break;
                default:
                    log(`æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${message.type}`, 'warning');
            }
        }
        
        function handleStatusMessage(data) {
            // æ›´æ–°è½¦è¾†çŠ¶æ€æŒ‰é’®
            const button = document.getElementById('toggle-vehicle-status');
            const statusText = document.getElementById('vehicle-status-text');
            
            if (data.vehicle_status_enabled) {
                button.textContent = 'åœæ­¢';
                button.className = 'btn-danger';
                statusText.textContent = 'è½¦è¾†çŠ¶æ€å‘é€: å¼€å¯';
                vehicleStatusEnabled = true;
            } else {
                button.textContent = 'å¯åŠ¨';
                button.className = 'btn-primary';
                statusText.textContent = 'è½¦è¾†çŠ¶æ€å‘é€: å…³é—­';
                vehicleStatusEnabled = false;
            }
            
            log(`çŠ¶æ€æ›´æ–°: è½¦è¾†çŠ¶æ€=${data.vehicle_status_enabled ? 'å¼€å¯' : 'å…³é—­'}`, 'info');
        }
        
        function handleDataUpdate(dataType, data) {
            switch (dataType) {
                case 'realtime':
                    stats.realtimeReceived++;
                    addRealtimeData(`å®æ—¶æ•°æ®: ${JSON.stringify(data)}`);
                    break;
                case 'head_tracking':
                    stats.headTrackingReceived++;
                    addHeadTrackingData(`å¤´éƒ¨è·Ÿè¸ª: ${JSON.stringify(data)}`);
                    break;
                case 'voice_text':
                    stats.voiceTextReceived++;
                    addVoiceTextData(`è¯­éŸ³æ–‡æœ¬: ${JSON.stringify(data)}`);
                    break;
                case 'voice_command':
                    stats.voiceCommandReceived++;
                    addVoiceCommandData(`è¯­éŸ³å‘½ä»¤: ${JSON.stringify(data)}`);
                    break;
                case 'ack':
                    stats.ackReceived++;
                    addAckData(`ç¡®è®¤åŒ…: ${JSON.stringify(data)}`);
                    break;
            }
        }
        
        function addRealtimeData(text) {
            addDataToList('realtime-data', text);
        }
        
        function addHeadTrackingData(text) {
            addDataToList('head-tracking-data', text);
        }
        
        function addVoiceTextData(text) {
            addDataToList('voice-text-data', text);
        }
        
        function addVoiceCommandData(text) {
            addDataToList('voice-command-data', text);
        }
        
        function addAckData(text) {
            addDataToList('ack-data', text);
        }
        
        function addDataToList(listId, text) {
            const list = document.getElementById(listId);
            const timestamp = new Date().toLocaleTimeString();
            const item = document.createElement('div');
            item.className = 'data-item';
            item.innerHTML = `[${timestamp}] ${text}`;
            
            list.insertBefore(item, list.firstChild);
            
            // ä¿æŒæœ€å¤š50æ¡æ•°æ®
            while (list.children.length > 50) {
                list.removeChild(list.lastChild);
            }
        }
        
        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const messageStr = JSON.stringify(message);
                ws.send(messageStr);
                log(`å‘é€æ¶ˆæ¯: ${messageStr}`, 'info');
            } else {
                log('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
            }
        }
        
        function toggleVehicleStatus() {
            if (!isConnected) {
                log('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ§åˆ¶å‘½ä»¤', 'error');
                return;
            }
            
            const newStatus = !vehicleStatusEnabled;
            sendMessage({
                type: 'toggle_vehicle_status',
                enabled: newStatus
            });
            
            log(`${newStatus ? 'å¯åŠ¨' : 'åœæ­¢'}è½¦è¾†çŠ¶æ€å‘é€`, 'info');
        }
        
        function setVehicleStatusInterval() {
            if (!isConnected) {
                log('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ§åˆ¶å‘½ä»¤', 'error');
                return;
            }
            
            const interval = parseFloat(document.getElementById('vehicle-status-interval').value);
            if (isNaN(interval) || interval <= 0) {
                log('è¯·è¾“å…¥æœ‰æ•ˆçš„å‘é€é¢‘ç‡', 'error');
                return;
            }
            
            sendMessage({
                type: 'set_vehicle_status_interval',
                interval: interval
            });
            
            log(`è®¾ç½®è½¦è¾†çŠ¶æ€å‘é€é¢‘ç‡ä¸º ${interval}Hz`, 'info');
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            const toggleBtn = document.getElementById('toggle-vehicle-status');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleVehicleStatus);
            } else {
                console.warn('æ‰¾ä¸åˆ°toggle-vehicle-statuså…ƒç´ ');
            }
            
            const intervalBtn = document.getElementById('set-interval');
            if (intervalBtn) {
                intervalBtn.addEventListener('click', setVehicleStatusInterval);
            } else {
                console.warn('æ‰¾ä¸åˆ°set-intervalå…ƒç´ ');
            }
        }
        
        // å®šæœŸè¯·æ±‚çŠ¶æ€æ›´æ–°
        function startStatusUpdate() {
            setInterval(() => {
                if (isConnected) {
                    sendMessage({
                        type: 'get_status'
                    });
                    
                    sendMessage({
                        type: 'get_received_data'
                    });
                }
            }, 5000);
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.addEventListener('load', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è¿æ¥WebSocket...', 'info');
            setupEventListeners();
            setTimeout(connectWebSocket, 1000); // å»¶è¿Ÿ1ç§’è¿æ¥
            startStatusUpdate();
        });
        
        // é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>