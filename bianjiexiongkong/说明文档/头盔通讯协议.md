# 车辆与头盔通信协议

## 概述

本文档定义了车辆与头盔之间的通信协议，包含四种不同类型的通信：
1. 车辆状态周期性下发（Vehicle to Helmet）
2. 头动跟踪数据上报（Helmet to Vehicle）
3. 语音文本上报（Helmet to Vehicle）
4. 语音指令双向通信（Helmet to Vehicle & Vehicle to Helmet）

所有协议均采用固定格式的数据包，使用网络字节序（大端模式），并包含CRC-16/MODBUS校验机制确保数据完整性。

---

## 1. 车辆状态下发通信协议 (Vehicle to Helmet)

### 协议说明
- **发送方式**: 定时发送，总发送频率为100Hz，数据包按顺序循环包含5个平台（本车、无人机1、无人机2、无人车1、无人车2）中某一个的状态信息，因此每个平台的状态更新频率为20Hz。
- **数据包长度**: 固定59字节

### 数据包格式

| 序号 | 字段名 | 字节偏移 | 长度(字节) | 数据类型 | 值域 | 说明 |
|------|--------|----------|------------|----------|------|------|
| 1 | 帧头(Header) | 0-1 | 2 | uint16_t | 0x55AE | 固定值，专用于状态上报 |
| 2 | 数据长度(Length) | 2-3 | 2 | uint16_t | 0x0037 (55) | 从Timestamp到Warnings字段结束的字节数 |
| 3 | 时间戳(Timestamp) | 4-7 | 4 | uint32_t | - | Unix时间戳(秒) |
| 4 | 平台标识(PlatformID) | 8 | 1 | uint8_t | 0-4 | 0:本车,1:无人机1,2:无人机2,3:无人车1,4:无人车2 |
| 5 | 经度(Longitude) | 9-12 | 4 | int32_t | - | WGS84坐标 × 1e7 |
| 6 | 纬度(Latitude) | 13-16 | 4 | int32_t | - | WGS84坐标 × 1e7 |
| 7 | 海拔高度(Altitude) | 17-20 | 4 | int32_t | - | 海拔高度 × 100 (0.01米) |
| 8 | 对地高度(GroundAltitude) | 21-24 | 4 | int32_t | - | 对地高度 × 100 (0.01米)，仅无人机有效，其他平台填0 |
| 9 | 航向角(Heading) | 25-28 | 4 | int32_t | - | 角度 × 100 (0.01度)，以北为0°，顺时针增加 |
| 10 | 横滚角(Roll) | 29-32 | 4 | int32_t | - | 横滚角 × 100 (0.01度) |
| 11 | 俯仰角(Pitch) | 33-36 | 4 | int32_t | - | 俯仰角 × 100 (0.01度) |
| 12 | 速度(Speed) | 37-38 | 2 | int16_t | - | 实际速度 × 10 (0.1 km/h) |
| 13 | 对地速度(GroundSpeed) | 39-40 | 2 | int16_t | - | 对地速度 × 10 (0.1 km/h)，仅无人机有效，其他平台填0 |
| 14 | 油量(FuelLevel) | 41 | 1 | uint8_t | 0-100 | 油量百分比(0-100%)，无效时填255 |
| 15 | 电量(BatteryLevel) | 42 | 1 | uint8_t | 0-100 | 电量百分比(0-100%)，无效时填255 |
| 16 | 云台/吊舱俯仰(GimbalPitch) | 43-46 | 4 | int32_t | - | 光电转台俯仰 × 100 (0.01度) |
| 17 | 云台/吊舱方位(GimbalYaw) | 47-50 | 4 | int32_t | - | 光电转台方位 × 100 (0.01度) |
| 18 | 云台/吊舱激活(GimbalActive) | 51 | 1 | uint8_t | 0/1 | 光电转台激活状态: 0=未激活, 1=激活 |
| 19 | 弹药类型1(AmmoType1) | 52 | 1 | uint8_t | 0-100 | 弹药类型1数量 |
| 20 | 弹药类型2(AmmoType2) | 53 | 1 | uint8_t | 0-100 | 弹药类型2数量 |
| 21 | 弹药类型3(AmmoType3) | 54 | 1 | uint8_t | 0-100 | 弹药类型3数量 |
| 22 | 警告(Warnings) | 55-56 | 2 | uint16_t | - | 警告位掩码，根据平台类型解释 |
| 23 | 校验和(Checksum) | 57-58 | 2 | uint16_t | - | CRC-16/MODBUS算法 |

### 警告位掩码定义

| 序号 | 位 | 名称 | 描述 | 适用平台 |
|------|----|------|------|----------|
| 1 | 0 | 通信故障(Comm Failure) | 与主站通信异常 | 所有平台 |
| 2 | 1 | 传感器异常(Sensor Anomaly) | 关键传感器数据异常 | 所有平台 |
| 3 | 2 | 电池低电量(Low Battery) | 电池电量低于阈值 | 所有平台 |
| 4 | 3 | 动力系统故障(Power System Failure) | 动力系统状态异常 | 所有平台 |
| 5 | 4 | 燃油不足(Low Fuel) | 燃油量低于阈值 | 车辆/无人车 |
| 6 | 5 | 武器系统故障(Weapon System Failure) | 武器系统状态异常 | 所有平台 |
| 7 | 6 | 悬挂系统异常(Suspension Anomaly) | 悬挂系统状态异常 | 车辆/无人车 |
| 8 | 7 | 制动系统异常(Brake System Anomaly) | 制动系统状态异常 | 车辆/无人车 |
| 9 | 8 | 传动系统异常(Transmission Anomaly) | 传动系统状态异常 | 车辆/无人车 |
| 10 | 9 | 北斗信号弱(Poor Beidou Signal) | 北斗信号质量差 | 所有平台 |
| 11 | 10 | 视觉定位异常(Vision Positioning Anomaly) | 视觉定位系统状态异常 | 无人机 |
| 12 | 11 | 避障系统异常(Avoidance System Anomaly) | 避障系统状态异常 | 无人机 |
| 13 | 12 | 图传信号弱(Poor Video Transmission) | 图像传输信号质量差 | 无人机 |
| 14 | 13-15 | 保留(Reserved) | 预留未来使用 | / |

### 实现说明
1. **字节序**: 所有多字节字段使用网络字节序(大端)
2. **缩放因子**:
   - 经纬度: 实际值 = 传输值 / 1e7
   - 海拔高度: 实际值 = 传输值 / 100.0 (米)
   - 对地高度: 实际值 = 传输值 / 100.0 (米)
   - 角度: 实际值 = 传输值 / 100.0 (度)
   - 速度: 实际值 = 传输值 / 10.0 (km/h)
   - 对地速度: 实际值 = 传输值 / 10.0 (km/h)
3. **朝向基准**: 以北为0°，顺时针增加角度
4. **校验和算法**: CRC-16/MODBUS (多项式 `0x8005`, 初始值 `0xFFFF`)
   - 计算范围: 从帧头(第0字节)到Warnings字段(第56字节)的所有字节（共57个字节）

---

## 2. 头动跟踪上报通讯协议 (Helmet to Vehicle)

### 协议说明
- **发送方式**: 定时将头盔的姿态和跟踪状态实时发送给车辆，频率100Hz
- **数据包长度**: 固定16字节

### 数据包格式

| 序号 | 字段名 | 字节偏移 | 长度(字节) | 数据类型 | 值域 | 说明 |
|------|--------|----------|------------|----------|------|------|
| 1 | 帧头(Header) | 0-1 | 2 | uint16_t | 0x55AB | 固定值 |
| 2 | 数据长度(Length) | 2-3 | 2 | uint16_t | 0x000A (10) | 从Yaw到Confidence字段结束的字节数 |
| 3 | 偏航角(Yaw) | 4-7 | 4 | int32_t | - | 角度 × 1e2，有效范围：-360.00° ~ 360.00° |
| 4 | 俯仰角(Pitch) | 8-11 | 4 | int32_t | - | 角度 × 1e2，有效范围：-90.00° ~ 90.00° |
| 5 | 跟踪状态(TrackingStatus) | 12 | 1 | uint8_t | 0/1 | 0=未跟踪, 1=跟踪中 |
| 6 | 置信度(Confidence) | 13 | 1 | uint8_t | 0-100 | 置信度百分比(0-100%) |
| 7 | 校验和(Checksum) | 14-15 | 2 | uint16_t | - | CRC-16/MODBUS算法 |

### 实现说明
1. **字节序**: 所有多字节字段使用网络字节序(大端)
2. **缩放因子**:
   - 角度: 实际值 = 传输值 / 100.0 (度)
3. **校验和算法**: CRC-16/MODBUS (多项式 `0x8005`, 初始值 `0xFFFF`)
   - 计算范围: 从Header到Confidence字段(前14字节)

---

## 3. 语音文本上报通讯协议 (Helmet to Vehicle)

### 协议说明
- **发送方式**: 触发式发送，将语音识别的中间结果和最终文本发送给平台，语音识别引擎产生新结果时立即发送
- **数据包长度**: 可变长度，最小8字节

### 数据包格式

| 序号 | 字段名 | 字节偏移 | 长度(字节) | 数据类型 | 值域 | 说明 |
|------|--------|----------|------------|----------|------|------|
| 1 | 帧头(Header) | 0-1 | 2 | uint16_t | 0x55AC | 固定值 |
| 2 | 数据长度(Length) | 2-3 | 2 | uint16_t | 可变 | 从Operation到TextData末尾的字节数(2+N) |
| 3 | 操作码(Operation) | 4 | 1 | uint8_t | - | 0x01=中间结果, 0x02=最终结果 |
| 4 | 包信息(PacketInfo) | 5 | 1 | uint8_t | 0x11 | 0x11=单包传输, 其他值保留用于多包传输 |
| 5 | 文本数据(TextData) | 6-(5+N) | N (可变) | uint8_t[] | UTF-8编码 | 文本数据的原始字节数组 |
| 6 | 校验和(Checksum) | (6+N)-(7+N) | 2 | uint16_t | - | CRC-16/MODBUS算法 |

### 实现说明
1. **Length字段值** = 1(Operation) + 1(PacketInfo) + N(TextData) = 2 + N 字节
2. **操作码说明**:
   - 0x01: 中间结果(语音识别过程中的部分结果)
   - 0x02: 最终结果(语音识别完成的最终文本)
3. **包信息说明**:
   - 0x11: 单包传输(所有文本数据在一个包中)
   - 其他值保留用于未来多包传输场景
4. **文本编码**: UTF-8编码，支持多语言文本
5. **校验和算法**: CRC-16/MODBUS (多项式 `0x8005`, 初始值 `0xFFFF`)
   - 计算范围: 从Header到TextData末尾的所有字节(前5+N字节)

---

## 4. 语音指令上报通讯协议（双向）

### 协议说明
- **发送方式**: 事件触发发送，配合可靠传输机制
- **确认机制**: 需要确认，维护发送消息池，支持重传
- **目的**: 实现可靠的语音指令双向通信
- **数据包长度**: 固定21字节(指令包)或9字节(确认包)

### 4.1 头盔至车辆数据包格式

| 序号 | 字段名 | 字节偏移 | 长度(字节) | 数据类型 | 值域 | 说明 |
|------|--------|----------|------------|----------|------|------|
| 1 | 帧头(Header) | 0-1 | 2 | uint16_t | 0x55AA | 固定值，网络字节序 |
| 2 | 数据长度(Length) | 2-3 | 2 | uint16_t | 0x000F (15) | 从Category到Param3字段结束的字节数 |
| 3 | 数据类别(Category) | 4 | 1 | uint8_t | 0x01~0x09 | 指令的大类 |
| 4 | 操作码(Operation) | 5 | 1 | uint8_t | 0x01~0xFF | 具体操作 |
| 5 | 命令ID(CommandID) | 6-9 | 4 | uint32_t | - | 命令的唯一标识符，网络字节序 |
| 6 | 参数1(Param1) | 10-13 | 4 | int32_t | - | 使用缩放因子，网络字节序 |
| 7 | 参数2(Param2) | 14-17 | 4 | int32_t | - | 使用缩放因子，网络字节序 |
| 8 | 参数3(Param3) | 18 | 1 | uint8_t | - | 用于开关、模式、百分比等 |
| 9 | 校验和(Checksum) | 19-20 | 2 | uint16_t | - | CRC-16/MODBUS算法，网络字节序 |

### 4.2 车辆至头盔确认包格式

| 序号 | 字段名 | 字节偏移 | 长度(字节) | 数据类型 | 值域 | 说明 |
|------|--------|----------|------------|----------|------|------|
| 1 | 帧头(Header) | 0-1 | 2 | uint16_t | 0x55AD | 固定值，专用于Ack |
| 2 | 命令ID(CommandID) | 2-5 | 4 | uint32_t | - | 需要确认的指令ID |
| 3 | 状态(Status) | 6 | 1 | uint8_t | 0x00:失败, 0x01:成功 | 执行结果 |
| 4 | 校验和(Checksum) | 7-8 | 2 | uint16_t | - | 计算前7字节的CRC |

### 4.3 协议指令表

#### 车辆环境控制系统 (Category: `0x01`)

| 序号 | 操作码 | 含义 | 参数1 | 参数2 | 参数3 | 说明 |
|------|--------|------|-------|-------|-------|------|
| 1 | 0x01 | 设置空调温度 | 温度×10 | 0 | 0 | 160~300 (16.0-30.0°C) |
| 2 | 0x02 | 调高温度 | 0 | 0 | 0 | - |
| 3 | 0x03 | 调低温度 | 0 | 0 | 0 | - |
| 4 | 0x04 | 设置风扇速度档位 | 0 | 0 | 档位(1-5) | - |
| 5 | 0x05 | 空调自动模式 | 0 | 0 | 开关(0/1) | - |
| 6 | 0x06 | 空调开关 | 0 | 0 | 开关(0/1) | - |
| 7 | 0x07 | 抽尘泵运行 | 0 | 0 | 开关(0/1) | 对应FlexRay协议 |
| 8 | 0x08 | 风扇强制运行 | 0 | 0 | 开关(0/1) | 对应FlexRay协议 |
| 9 | 0x09 | 水泵强制运行 | 0 | 0 | 开关(0/1) | 对应FlexRay协议 |
| 10 | 0x0A | 低温启动 | 0 | 0 | 开关(0/1) | 对应FlexRay协议 |

#### 车辆灯光与信号系统 (Category: `0x02`)

| 序号 | 操作码 | 含义 | 参数1 | 参数2 | 参数3 | 说明 |
|------|--------|------|-------|-------|-------|------|
| 1 | 0x01 | 左转向灯 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 2 | 0x02 | 右转向灯 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 3 | 0x03 | 左前大灯近光 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 4 | 0x04 | 右前大灯近光 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 5 | 0x05 | 左前大灯远光 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 6 | 0x06 | 右前大灯远光 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 7 | 0x07 | 示廓灯 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 8 | 0x08 | 危险告警灯 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 9 | 0x09 | 喇叭 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 10 | 0x0A | 防空 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 11 | 0x0B | 喷水 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 12 | 0x0C | 左切屏 | 0 | 0 | 开关(0/1) | 对应方向盘 |
| 13 | 0x0D | 右切屏 | 0 | 0 | 开关(0/1) | 对应方向盘 |

#### 车辆行驶模式 (Category: `0x03`)

| 序号 | 操作码 | 含义 | 参数1 | 参数2 | 参数3 | 说明 |
|------|--------|------|-------|-------|-------|------|
| 1 | 0x01 | 设置车辆模式 | 0 | 0 | 模式(1-5) | 1=静默,2=混动,3=停车发电,4=动力,5=经济 |

#### 车辆信息系统 (Category: `0x04`)

| 序号 | 操作码 | 含义 | 参数1 | 参数2 | 参数3 | 说明 |
|------|--------|--------|-------|-------|-------|------|
| 1 | 0x01 | 显示前方视频 | 0 | 0 | 0 | - |
| 2 | 0x02 | 显示后方视频 | 0 | 0 | 0 | - |
| 3 | 0x03 | 显示状态信息 | 0 | 0 | 0 | - |
| 4 | 0x04 | 显示地图 | 0 | 0 | 0 | - |
| 5 | 0x05 | 显示热成像 | 0 | 0 | 0 | - |
| 6 | 0x06 | 切换视频源 | 0 | 0 | 视频源编号(1-n) | - |

#### 通信与导航 (Category: `0x05`)

| 序号 | 操作码 | 含义 | 参数1 | 参数2 | 参数3 | 说明 |
|------|--------|------|-------|-------|-------|------|
| 1 | 0x01 | 建立通信链路 | 0 | 0 | 0 | - |
| 2 | 0x02 | 终止通信链路 | 0 | 0 | 0 | - |
| 3 | 0x03 | 设置航点 | 纬度×1e7 | 经度×1e7 | 0 | - |
| 4 | 0x04 | 清除所有航点 | 0 | 0 | 0 | - |
| 5 | 0x05 | 请求返航 | 0 | 0 | 0 | - |
| 6 | 0x06 | 开始执行任务 | 0 | 0 | 0 | - |

#### 系统状态查询 (Category: `0x06`)

| 序号 | 操作码 | 含义 | 参数1 | 参数2 | 参数3 | 说明 |
|------|--------|------|-------|-------|-------|------|
| 1 | 0x01 | 查询电池状态 | 0 | 0 | 0 | - |
| 2 | 0x02 | 查询燃油状态 | 0 | 0 | 0 | - |
| 3 | 0x03 | 查询弹药状态 | 0 | 0 | 0 | - |
| 4 | 0x04 | 查询位置信息 | 0 | 0 | 0 | - |
| 5 | 0x05 | 查询所有系统状态 | 0 | 0 | 0 | - |
| 6 | 0x06 | 查询通信状态 | 0 | 0 | 0 | - |
| 7 | 0x07 | 查询传感器状态 | 0 | 0 | 0 | - |

#### 无人机控制指令 (Category: `0x07`)

| 序号 | 操作码 | 含义 | 参数1 | 参数2 | 参数3 | 说明 |
|------|--------|------|-------|-------|-------|------|
| 1 | 0x01 | 起飞 | 0 | 0 | 0 | - |
| 2 | 0x02 | 降落 | 0 | 0 | 0 | - |
| 3 | 0x03 | 返航 | 0 | 0 | 0 | - |
| 4 | 0x04 | 悬停 | 0 | 0 | 0 | - |
| 5 | 0x05 | 上升/下降 | 距离×100 | 0 | 0 | 厘米，传输值表示厘米数，实际距离=传输值/100.0米 ,正值上升/负值下降 |
| 6 | 0x06 | 前进/后退 | 距离×100 | 0 | 0 | 厘米，传输值表示厘米数，实际距离=传输值/100.0米 ,正值前进/负值后退 |
| 7 | 0x07 | 左移/右移 | 距离×100 | 0 | 0 | 厘米，传输值表示厘米数，实际距离=传输值/100.0米 ,正值右移/负值左移 |
| 8 | 0x08 | 光电吊舱变焦(放大) | 0 | 0 | 0 | - |
| 9 | 0x09 | 光电吊舱变焦(缩小) | 0 | 0 | 0 | - |
| 10 | 0x0A | 光电吊舱云台左转 | 角度×100 | 0 | 0 | 0.01度 |
| 11 | 0x0B | 光电吊舱云台右转 | 角度×100 | 0 | 0 | 0.01度 |
| 12 | 0x0C | 光电吊舱云台上仰 | 角度×100 | 0 | 0 | 0.01度 |
| 13 | 0x0D | 光电吊舱云台下俯 | 角度×100 | 0 | 0 | 0.01度 |

#### 无人车控制指令 (Category: `0x08`)

| 序号 | 操作码 | 含义 | 参数1 | 参数2 | 参数3 | 说明 |
|------|--------|------|-------|-------|-------|------|
| 1 | 0x01 | 工作模式 | 0 | 0 | 模式(1-2) | 1=有人,2=无人 |
| 2 | 0x02 | 紧急停止 | 0 | 0 | 0 | - |
| 3 | 0x03 | UGV前进 | 0 | 0 | 0 | - |
| 4 | 0x04 | UGV后退 | 0 | 0 | 0 | - |
| 5 | 0x05 | UGV左转 | 0 | 0 | 0 | - |
| 6 | 0x06 | UGV右转 | 0 | 0 | 0 | - |
| 7 | 0x07 | UGV停止 | 0 | 0 | 0 | - |
| 8 | 0x08 | 设置UGV速度 | 速度×10 | 0 | 0 | 0.1 km/h |
| 9 | 0x09 | UGV前进N米 | 距离×100 | 0 | 0 | 厘米，传输值表示厘米数，实际距离=传输值/100.0米 |
| 10 | 0x0A | UGV后退N米 | 距离×100 | 0 | 0 | 厘米，传输值表示厘米数，实际距离=传输值/100.0米 |
| 11 | 0x0B | UGV左转N度 | 角度×100 | 0 | 0 | 0.01度 |
| 12 | 0x0C | UGV右转N度 | 角度×100 | 0 | 0 | 0.01度 |
| 13 | 0x0D | UGV跟随 | 0 | 0 | 0 | - |
| 14 | 0x0E | UGV切换至自主模式 | 0 | 0 | 0 | - |
| 15 | 0x0F | UGV切换至手动模式 | 0 | 0 | 0 | - |

#### 应急指令 (Category: `0x09`)

| 序号 | 操作码 | 含义 | 参数1 | 参数2 | 参数3 | 说明 |
|------|--------|------|-------|-------|-------|------|
| 1 | 0x01 | 紧急制动(急停) | 0 | 0 | 0 | - |
| 2 | 0x02 | 紧急恢复(缓停) | 0 | 0 | 0 | - |
| 3 | 0x03 | 释放烟雾/诱饵 | 0 | 0 | 0 | - |
| 4 | 0x04 | 发送求救信号 | 0 | 0 | 0 | - |
| 5 | 0x05 | 进入安全模式 | 0 | 0 | 0 | - |

### 实现说明
1. **可靠传输机制**: 需要维护发送消息池(`std::map`或类似结构)，key为`command_id`，value为指令包数据、发送时间戳、重发次数
2. **重传机制**: 超时时间200ms，最大重试次数3次
3. **校验和算法**: CRC-16/MODBUS (多项式 `0x8005`, 初始值 `0xFFFF`)
4. **字节序**: 所有大于1字节的字段必须使用网络字节序(大端模式)
5. **未使用字段**: 设置为0以确保数据一致性
6. **缩放因子**:
   - 温度: 实际值 = 传输值 / 10.0 (°C)
   - 距离: 传输值表示厘米数，实际距离 = 传输值 / 100.0 (米)
   - 角度: 实际值 = 传输值 / 100.0 (度)
   - 速度: 实际值 = 传输值 / 10.0 (km/h)

---

## 通用注意事项

1. 所有协议均使用固定格式数据包，简化了解析逻辑
2. 通过平台标识/数据类别字段，可以灵活区分不同来源和类型的数据
3. 接收端需要根据相应字段判断数据来源和类型，并相应解释数据内容
4. 时间戳字段可用于数据同步和延迟计算
5. 角度值以0.01度为单位传输，接收端需转换为所需单位制
6. 警告位掩码采用统一编码，不同平台类型关注不同的位
7. 不同平台的专用字段应正确处理，不需要的字段填0，接收端根据平台类型忽略相应字段
8. 所有多字节字段使用网络字节序(大端模式)
9. 校验和均使用CRC-16/MODBUS算法(多项式 `0x8005`, 初始值 `0xFFFF`)
10. 距离参数说明：所有涉及距离的指令参数，传输值表示厘米数，实际距离=传输值/100.0米

---

## 版本历史
- 初始版本: 定义完整的车辆与头盔通信协议
- 修订说明: 统一了协议格式，补充了缺失的说明，确保了逻辑一致性